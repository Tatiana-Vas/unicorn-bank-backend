generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  PARENT
  CHILD
}

enum TransactionSource {
  TASK_REWARD
  POCKET_MONEY
  INTEREST
  MANUAL_TOPUP
  GIFT
  BONUS
  CASH
  PURCHASE
}

enum TaskScheduleType {
  ONE_TIME
  DAILY
  EVERY_N_DAYS
  WEEKLY
  MONTHLY
}

enum TaskCompletionStatus {
  NEW
  COMPLETED
  APPROVED
  REJECTED
  DECLINED_BY_CHILD
  EXPIRED
}

enum RequestType {
  NEW_TASK
  TASK_APPROVAL
  WISHLIST_PURCHASE
  MONEY_WITHDRAW
  NEW_DEPOSIT
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DepositStatus {
  ACTIVE
  CLOSED
}

model Parent {
  id         String        @id
  email      String        @unique
  password   String
  name       String
  avatarUrl  String?
  createdAt DateTime      @default(now())
  updatedAt DateTime

  children   ParentChild[]
}

model Child {
  id           String           @id
  name         String
  password     String
  birthDate    DateTime?
  city         String?
  locale       String?
  newsPrompt   String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime

  parents      ParentChild[]
  spending     SpendingAccount?
  deposits     Deposit[]
  tasks        Task[]
  taskInstances TaskInstance[]
  requests     Request[]
  wishlist     WishlistItem[]
}

model ParentChild {
  parentId String
  childId  String
  createdAt DateTime @default(now())

  parent Parent @relation(fields: [parentId], references: [id])
  child  Child  @relation(fields: [childId], references: [id])

  @@id([parentId, childId])
}

model SpendingAccount {
  id        String   @id
  balance   Decimal  @default(0)
  childId   String   @unique
  createdAt DateTime @default(now())

  child        Child         @relation(fields: [childId], references: [id])
  transactions Transaction[]
}

model Deposit {
  id            String        @id
  amount        Decimal
  interestRate  Float
  startsAt      DateTime
  endsAt        DateTime
  status        DepositStatus @default(ACTIVE)
  childId       String
  createdAt     DateTime      @default(now())

  child         Child         @relation(fields: [childId], references: [id])
  transactions  Transaction[]
}

model Transaction {
  id                 String            @id
  amount             Decimal
  source             TransactionSource
  comment            String?
  spendingAccountId  String?
  depositId          String?
  createdAt          DateTime          @default(now())

  spendingAccount SpendingAccount? @relation(fields: [spendingAccountId], references: [id])
  deposit          Deposit?         @relation(fields: [depositId], references: [id])
}

model Task {
  id            String           @id
  title         String
  description   String?
  reward        Decimal
  scheduleType  TaskScheduleType
  intervalDays  Int?
  weekDays      Int[]
  dayOfMonth    Int?
  startsAt      DateTime
  endsAt        DateTime?
  childId       String
  createdAt     DateTime         @default(now())

  child         Child            @relation(fields: [childId], references: [id])
  instances     TaskInstance[]
}

model TaskInstance {
  id        String               @id
  date      DateTime
  status    TaskCompletionStatus @default(NEW)
  taskId    String
  childId   String
  createdAt DateTime             @default(now())

  task  Task  @relation(fields: [taskId], references: [id])
  child Child @relation(fields: [childId], references: [id])
}

model Request {
  id         String        @id
  type       RequestType
  status     RequestStatus @default(PENDING)
  childId    String
  payload    Json
  createdAt  DateTime      @default(now())
  resolvedAt DateTime?

  child Child @relation(fields: [childId], references: [id])
}

model Notification {
  id        String   @id
  userRole  UserRole
  userId    String
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model WishlistItem {
  id        String   @id
  title     String
  price     Decimal
  imageUrl  String?
  childId   String
  createdAt DateTime @default(now())

  child Child @relation(fields: [childId], references: [id])
}
